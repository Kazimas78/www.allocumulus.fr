# ALLOcumulus Deploy Workflow - v1.1
name: Deploy to LWS (SFTP)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Upload via SFTP mirror
        shell: bash
        env:
          HOST: ${{ secrets.LWS_SFTP_HOST }}
          USER: ${{ secrets.LWS_SFTP_USER }}
          PASS: ${{ secrets.LWS_SFTP_PASS }}
          PORT: ${{ secrets.LWS_SFTP_PORT }}
          REMOTE_DIR: ${{ secrets.LWS_REMOTE_DIR }}
        run: |
          set -euo pipefail

          # Verify required secrets exist (without printing them)
          for v in HOST USER PASS PORT REMOTE_DIR; do
            if [ -z "${!v:-}" ]; then
              echo "ERROR: secret $v is empty or missing."
              exit 2
            fi
          done

          echo "Deploy target: host=${HOST} port=${PORT} remote_dir=${REMOTE_DIR}"

          lftp -e "
            set sftp:auto-confirm yes;
            set net:timeout 20;
            set net:max-retries 2;

            open -u ${USER},${PASS} -p ${PORT} sftp://${HOST};

            # Ensure remote directory exists, then work inside it
            mkdir -p ${REMOTE_DIR};
            cd ${REMOTE_DIR};

            # Upload current repo content into remote current dir
            mirror -R --verbose --parallel=2 --no-perms --no-umask \
              --exclude-glob .git/ \
              --exclude-glob .github/ \
              ./ ./;

            bye
          "
